# Implementation Plan: Phase 2 - Full Web App

**Branch**: `002-full-web-app` | **Date**: 2025-12-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-full-web-app/spec.md`

**Note**: This plan is generated by the `/sp.plan` command following the Spec-Driven Development workflow.

## Summary

Phase 2 transforms the Phase 1 Python CLI into a production-ready web application with multi-user support. The system will provide a responsive Next.js frontend, FastAPI backend with RESTful endpoints, Neon PostgreSQL database for multi-user task storage, and JWT-based authentication with password reset capabilities. This phase enables web-based access to all Phase 1 CRUD operations (add, view, edit, complete, delete tasks) with user registration, login, and data isolation per user.

**Primary Requirement**: Migrate from single-user CLI (JSON file) to multi-user web app (PostgreSQL) with authentication
**Technical Approach**: Next.js 14+ SPA → FastAPI REST API → Neon PostgreSQL, JWT tokens, SendGrid emails

## Technical Context

**Language/Version**:
- Frontend: TypeScript 5.0+ with Next.js 14+ (React 18+)
- Backend: Python 3.11+ with FastAPI 0.104+

**Primary Dependencies**:
- Frontend: Next.js, React, TailwindCSS, axios/fetch, jwt-decode
- Backend: FastAPI, SQLAlchemy, Alembic, PyJWT, bcrypt, psycopg2-binary, SendGrid SDK

**Storage**:
- Database: Neon PostgreSQL (serverless)
- Schema: Users table (id, email, password_hash, display_name, created_at, updated_at)
- Schema: Tasks table (7 fields from Phase 1 + user_id foreign key + updated_at)
- Schema: RefreshTokens table (id, user_id, token, expires_at, created_at)

**Testing**:
- Backend: pytest, pytest-asyncio, httpx (for FastAPI test client)
- Frontend: Jest, React Testing Library, Vitest
- E2E: Playwright (critical user flows)

**Target Platform**:
- Frontend: Vercel (Next.js serverless deployment)
- Backend: Railway or Render (Python ASGI server - Uvicorn)
- Database: Neon PostgreSQL (hosted, serverless)

**Project Type**: Web application (frontend + backend)

**Performance Goals**:
- API response time: p95 < 200ms (constitution requirement)
- Database query time: p95 < 100ms
- Frontend initial load: < 3 seconds
- Support: 1,000 concurrent authenticated users minimum

**Constraints**:
- Must maintain Phase 1 task schema compatibility (7 fields preserved)
- Must provide migration script for Phase 1 JSON → PostgreSQL
- Must pass all Phase 1 regression tests with migrated data
- Must follow RESTful API design principles
- Must implement 12-factor app methodology (config via env, stateless API)

**Scale/Scope**:
- Expected: 1,000 users initially, 10-50 tasks per user average
- Database: Single PostgreSQL instance (Neon serverless free tier initially)
- Frontend bundle: < 500KB gzipped
- API endpoints: ~15 endpoints (auth + CRUD + user profile)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Phase-Driven Evolution ✅ PASS

**Requirement**: Phase 2 starts only after Phase 1 complete and tested
**Status**: COMPLIANT
- ✅ Phase 1 complete: 75/75 tasks done, 50/50 tests passing
- ✅ All Phase 1 acceptance criteria met (see PHASE-1-SUMMARY.md)
- ✅ No Phase 3+ features leaked (no AI/OpenAI Agents SDK)
- ✅ Clear migration path documented (JSON → PostgreSQL)

### II. Cloud-Native Architecture ✅ PASS

**Requirement**: Cloud-native design from Phase 2 onward
**Status**: COMPLIANT
- ✅ 12-factor app: Config via environment variables (.env files)
- ✅ Stateless API: JWT tokens, no server-side sessions
- ✅ Port binding: Frontend (3000), Backend (8000)
- ✅ Prepared for Phase 4 containerization (no localhost hardcoding)

### III. AI-First Integration ⏸️ DEFERRED

**Requirement**: AI capabilities in Phase 3+
**Status**: CORRECTLY DEFERRED TO PHASE 3
- Phase 2 establishes REST API that will support MCP tool wrapping in Phase 3
- Task entity endpoints designed for AI agent consumption

### IV. Event-Driven Communication ⏸️ DEFERRED

**Requirement**: Kafka event patterns in Phase 5+
**Status**: CORRECTLY DEFERRED TO PHASE 5
- Phase 2 uses synchronous REST API
- Event-driven patterns added in Phase 5

### V. Dapr Service Mesh Integration ⏸️ DEFERRED

**Requirement**: Dapr for cross-cutting concerns in Phase 5+
**STATUS**: CORRECTLY DEFERRED TO PHASE 5
- Phase 2 uses direct service calls
- Dapr integration in Phase 5

### VI. Database-Backed Persistence ✅ PASS

**Requirement**: Neon PostgreSQL from Phase 2 onward
**Status**: COMPLIANT
- ✅ Neon PostgreSQL selected as primary datastore
- ✅ SQLAlchemy ORM for type-safe queries
- ✅ Alembic migrations for schema versioning
- ✅ Connection pooling configured
- ✅ Prepared statements prevent SQL injection
- ✅ Database indexes on user_id, status, created_at
- ✅ Foreign key constraints (tasks.user_id → users.id)

### VII. Authentication & Authorization ✅ PASS

**Requirement**: JWT authentication in Phase 2+
**Status**: COMPLIANT
- ✅ JWT tokens with 24-hour expiration (FR-004)
- ✅ Refresh tokens for session extension (FR-006)
- ✅ bcrypt password hashing with 10 salt rounds (FR-003)
- ✅ Password reset via email verification (FR-005)
- ✅ Rate limiting: 100 requests/minute per user (FR-024)
- ✅ Minimum password requirements enforced (FR-008)

### VIII. Test-First Development ✅ PASS

**Requirement**: TDD workflow for all phases
**Status**: COMPLIANT
- ✅ Phase 2 will follow TDD: Write tests → Implement → Tests pass
- ✅ Test categories planned: Unit (business logic), Integration (API endpoints), E2E (user flows)
- ✅ Regression tests from Phase 1 will be migrated and must pass

### IX. Observability & Monitoring ✅ PASS

**Requirement**: Structured logs, metrics, traces
**Status**: COMPLIANT
- ✅ Structured JSON logging (Python logging + FastAPI middleware)
- ✅ Request correlation IDs for tracing
- ✅ Error logging with stack traces
- ✅ Health check endpoints (/health, /ready)

### X. Simplicity & Incremental Complexity ✅ PASS

**Requirement**: Add complexity only when justified
**Status**: COMPLIANT
- ✅ Phase 2 scope appropriate: Web UI + REST API + PostgreSQL + JWT
- ✅ No premature optimization (no caching, no CDN, no microservices)
- ✅ Minimal frontend (React + Next.js, no complex state management)
- ✅ REST API only (no GraphQL, no gRPC)

**GATE STATUS**: ✅ ALL GATES PASSED - Proceed to Phase 0 Research

---

## Constitution Check - Post-Design Re-Evaluation

*Re-evaluated after completing Phase 0 (Research) and Phase 1 (Design) artifacts*

**Artifacts Reviewed**:
- ✅ research.md (technology decisions documented)
- ✅ data-model.md (database schema with User, Task, RefreshToken entities)
- ✅ contracts/api-endpoints.md (REST API documentation)
- ✅ contracts/openapi.yaml (OpenAPI 3.0 specification)
- ✅ quickstart.md (development setup guide)

### Final Constitution Compliance Assessment

#### I. Phase-Driven Evolution ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ No Phase 3+ features in design (AI/MCP tools deferred)
- ✅ No Phase 4+ features in design (Docker/Kubernetes deferred)
- ✅ API endpoints designed for future MCP tool wrapping (GET /tasks, POST /tasks, etc.)

#### VI. Database-Backed Persistence ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ Neon PostgreSQL schema defined with proper indexes (data-model.md)
- ✅ Alembic migration strategy documented
- ✅ Connection pooling strategy defined (research.md: 5-20 connections)
- ✅ Foreign keys and CASCADE deletes for data integrity

#### VII. Authentication & Authorization ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ JWT dual-token pattern designed (24h access + 7d refresh)
- ✅ bcrypt password hashing specified (10 salt rounds, research.md)
- ✅ Password reset flow with SendGrid documented (contracts/api-endpoints.md)
- ✅ Rate limiting specified (100 req/min auth, 1000 req/min general)

#### VIII. Test-First Development ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ Testing strategies defined (research.md: pytest fixtures, in-memory SQLite, Playwright E2E)
- ✅ Test database setup documented (quickstart.md)
- ✅ TDD workflow will be enforced in tasks.md

#### IX. Observability & Monitoring ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ Health endpoints designed (/health, /ready with database connectivity check)
- ✅ Structured logging approach specified (research.md: JSON logs, correlation IDs)
- ✅ Error response format standardized (contracts/api-endpoints.md)

#### X. Simplicity & Incremental Complexity ✅ PASS

**Post-Design Status**: COMPLIANT
- ✅ No over-engineering detected in design artifacts
- ✅ REST API only (no GraphQL, no gRPC)
- ✅ Next.js Context API for state (no Redux)
- ✅ Direct API calls (no complex DDD patterns)

**FINAL GATE STATUS**: ✅ ALL GATES PASSED - Ready for `/sp.tasks` command

## Project Structure

### Documentation (this feature)

```text
specs/002-full-web-app/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command) - Technology decisions
├── data-model.md        # Phase 1 output (/sp.plan command) - Database schema
├── quickstart.md        # Phase 1 output (/sp.plan command) - Setup guide
├── contracts/           # Phase 1 output (/sp.plan command) - API contracts
│   ├── api-endpoints.md # REST API documentation
│   └── openapi.yaml     # OpenAPI 3.0 specification
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
# Option 2: Web application (frontend + backend)

backend/
├── src/
│   ├── main.py                    # FastAPI app entry point
│   ├── config.py                  # Environment config (12-factor)
│   ├── models/
│   │   ├── user.py                # SQLAlchemy User model
│   │   ├── task.py                # SQLAlchemy Task model (Phase 1 + user_id)
│   │   └── refresh_token.py       # SQLAlchemy RefreshToken model
│   ├── schemas/
│   │   ├── user.py                # Pydantic request/response schemas
│   │   ├── task.py                # Pydantic task schemas
│   │   └── auth.py                # Pydantic auth schemas (login, register, token)
│   ├── services/
│   │   ├── auth_service.py        # JWT generation, password hashing, validation
│   │   ├── task_service.py        # Task CRUD logic (migrated from Phase 1)
│   │   ├── user_service.py        # User management
│   │   └── email_service.py       # SendGrid integration for password reset
│   ├── api/
│   │   ├── routes/
│   │   │   ├── auth.py            # /api/auth/register, /login, /refresh, /reset-password
│   │   │   ├── tasks.py           # /api/tasks CRUD endpoints
│   │   │   └── users.py           # /api/users/me, /profile
│   │   └── dependencies.py        # Auth dependency injection (get_current_user)
│   ├── db/
│   │   ├── database.py            # SQLAlchemy engine, session factory
│   │   └── migrations/            # Alembic migrations
│   └── utils/
│       ├── validators.py          # Input validation (migrated from Phase 1)
│       └── security.py            # Password strength validation, token utils
├── tests/
│   ├── unit/
│   │   ├── test_auth_service.py
│   │   ├── test_task_service.py
│   │   └── test_validators.py
│   ├── integration/
│   │   ├── test_auth_endpoints.py
│   │   ├── test_task_endpoints.py
│   │   └── test_database.py
│   └── conftest.py                # pytest fixtures (test DB, test client)
├── alembic.ini                    # Alembic configuration
├── requirements.txt               # Production dependencies
├── requirements-dev.txt           # Development dependencies (pytest, etc.)
└── .env.example                   # Environment variable template

frontend/
├── src/
│   ├── app/
│   │   ├── layout.tsx             # Root layout
│   │   ├── page.tsx               # Landing page
│   │   ├── login/
│   │   │   └── page.tsx           # Login page
│   │   ├── register/
│   │   │   └── page.tsx           # Registration page
│   │   ├── dashboard/
│   │   │   └── page.tsx           # Task dashboard (main app)
│   │   └── profile/
│   │       └── page.tsx           # User profile settings
│   ├── components/
│   │   ├── TaskList.tsx           # Task list component with filters
│   │   ├── TaskForm.tsx           # Add/Edit task form
│   │   ├── TaskItem.tsx           # Individual task card
│   │   ├── AuthForm.tsx           # Reusable login/register form
│   │   └── Header.tsx             # Navigation header
│   ├── services/
│   │   ├── api.ts                 # Axios instance with auth interceptors
│   │   ├── authService.ts         # Login, register, logout, token refresh
│   │   └── taskService.ts         # Task CRUD API calls
│   ├── hooks/
│   │   ├── useAuth.tsx            # Auth context and hooks
│   │   └── useTasks.tsx           # Task state management
│   ├── types/
│   │   ├── user.ts                # User type definitions
│   │   └── task.ts                # Task type definitions (Phase 1 schema)
│   └── utils/
│       ├── storage.ts             # LocalStorage helpers (JWT tokens)
│       └── formatters.ts          # Date formatting, task display
├── tests/
│   ├── unit/
│   │   └── components/
│   └── e2e/
│       └── auth.spec.ts           # Playwright E2E tests
├── public/                        # Static assets
├── package.json
├── tsconfig.json
├── next.config.js
├── tailwind.config.js
└── .env.local.example             # Frontend env template

scripts/
└── migrate-phase1-data.py         # Migration script: JSON → PostgreSQL

.github/
└── workflows/
    ├── backend-tests.yml          # Backend CI/CD
    └── frontend-tests.yml         # Frontend CI/CD
```

**Structure Decision**: Web application structure (Option 2) selected because Phase 2 introduces frontend (Next.js) and backend (FastAPI) as separate deployable units. Frontend deploys to Vercel, backend to Railway/Render, database to Neon. This separation enables independent scaling and follows cloud-native principles from the constitution.

## Complexity Tracking

> **No violations detected** - Phase 2 scope aligns with constitution principles. All complexity additions (web framework, database, auth) are mandated by Phase 2 requirements and constitution.

---

*Plan status: ✅ GATES PASSED - Proceeding to Phase 0 Research*
